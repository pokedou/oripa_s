<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>オリパ収支シミュレーター（勝ち逃げ条件追加）</title>
  <style>
    body { font-family: sans-serif; margin: 20px; background: #f9f9f9; }
    input, select { width: 100%; padding: 10px; margin: 5px 0; font-size: 1em; box-sizing: border-box; }
    label { font-weight: bold; display: block; margin-top: 15px; }
    button { margin-top: 20px; padding: 12px; font-size: 1.2em; width: 100%; background: #007bff; color: white; border: none; border-radius: 5px; }
    button:hover { background: #0056b3; }
    #results { margin-top: 20px; padding: 15px; background: white; font-size: 1.1em; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    .player-settings { background: #fff; padding: 10px; margin-top: 10px; border-radius: 6px; box-shadow: 0 0 3px rgba(0,0,0,0.1); }
    pre { background: #eee; padding: 10px; border-radius: 5px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>オリパ収支シミュレーター</h1>

  <label>賭け金（1口）</label>
  <input id="price" value="11000" type="number">

  <label>当たり金額（表示）</label>
  <input id="winValue" value="22000" type="number">

  <label>当たり原価率（例: 0.9）</label>
  <input id="rate" value="0.9" type="number" step="0.01">

  <label>当たりの数</label>
  <input id="winCount" value="25" type="number">

  <label>ハズレの数</label>
  <input id="loseCount" value="25" type="number">

  <label>プレイヤー数（最大10）</label>
  <input id="playerCount" value="5" type="number" onchange="renderPlayerSettings()">

  <label>シミュレーション回数</label>
  <input id="simCount" value="100" type="number">

  <div id="playerSettings"></div>

  <button onclick="runSimulation()">シミュレーション開始</button>

  <div id="results"></div>

  <script>
    function renderPlayerSettings() {
      const count = parseInt(document.getElementById("playerCount").value);
      const container = document.getElementById("playerSettings");
      container.innerHTML = "";

      for (let i = 0; i < count; i++) {
        const div = document.createElement("div");
        div.className = "player-settings";
        div.innerHTML = `
          <label>プレイヤー${i + 1}：動作タイプ</label>
          <select id="type${i}">
            <option value="escape">勝ち逃げ</option>
            <option value="fixed">固定口数</option>
          </select>
          <label>最大口数（固定タイプ用）</label>
          <input type="number" id="pulls${i}" value="2">
          <label>撤退ライン（マイナス収支）</label>
          <input type="number" id="lossLimit${i}" value="">
          <label>勝ち逃げライン（プラス収支）</label>
          <input type="number" id="winLimit${i}" value="">
        `;
        container.appendChild(div);
      }
    }

    renderPlayerSettings();

    function runSimulation() {
      const price = parseInt(document.getElementById("price").value);
      const winValue = parseInt(document.getElementById("winValue").value);
      const rate = parseFloat(document.getElementById("rate").value);
      const winCount = parseInt(document.getElementById("winCount").value);
      const loseCount = parseInt(document.getElementById("loseCount").value);
      const playerCount = parseInt(document.getElementById("playerCount").value);
      const simCount = parseInt(document.getElementById("simCount").value);
      const winCost = winValue * rate;

      const playerConfigs = [];
      for (let i = 0; i < playerCount; i++) {
        const type = document.getElementById(`type${i}`).value;
        const pulls = parseInt(document.getElementById(`pulls${i}`).value);
        const lossLimit = parseInt(document.getElementById(`lossLimit${i}`).value) || null;
        const winLimit = parseInt(document.getElementById(`winLimit${i}`).value) || null;
        playerConfigs.push({ type, pulls, lossLimit, winLimit });
      }

      let operatorWins = 0;
      let exampleDetail = "";

      for (let i = 0; i < simCount; i++) {
        let pool = Array(winCount).fill(winCost).concat(Array(loseCount).fill(0));
        shuffle(pool);

        let opened = 0;
        let totalRevenue = 0;
        let totalCost = 0;
        let detail = "";

        for (let p = 0; p < playerConfigs.length; p++) {
          const config = playerConfigs[p];
          let userCost = 0;
          let userReturn = 0;
          let pulls = 0;
          const maxPulls = config.type === "fixed" ? config.pulls : pool.length - opened;

          while (opened < pool.length && pulls < maxPulls) {
            userCost += price;
            userReturn += pool[opened];
            pulls++;
            opened++;

            const profit = userReturn - userCost;
            if (config.lossLimit !== null && profit < config.lossLimit) break;
            if (config.type === "escape" && config.winLimit !== null && profit >= config.winLimit) break;
            if (config.type === "escape" && config.winLimit === null && profit > 0) break;
          }

          totalRevenue += userCost;
          totalCost += userReturn;

          detail += `プレイヤー${p + 1}：${pulls}口 / 支払 ${userCost.toLocaleString()}円 / 回収 ${userReturn.toLocaleString()}円 / 収支 ${(userReturn - userCost).toLocaleString()}円\n`;

          if (opened >= pool.length) break;
        }

        if (i === 0) exampleDetail = detail;
        if (totalRevenue - totalCost > 0) operatorWins++;
      }

      document.getElementById("results").innerHTML =
        `<strong>運営が勝った回数:</strong> ${operatorWins} / ${simCount}<br>
         <strong>勝率:</strong> ${(operatorWins / simCount * 100).toFixed(1)}%<br><br>
         <strong>1回目の詳細（プレイヤー損益）:</strong><br><pre>${exampleDetail}</pre>`;
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
  </script>
</body>
</html>
